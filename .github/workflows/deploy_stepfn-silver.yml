name: Deploy Step Functions (Silver) + Schedule

on:
  push:
    paths:
      - ".github/workflows/deploy-stepfn-silver.yml"
      - "infra/stepfn/silver_state_machine.json"
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:
  deploy-stepfn:
    environment: kerok-vistia-env
    if: ${{ toJSON(vars.ENABLE_DEPLOY) == '"true"' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ vars.AWS_ACCOUNT_ID }}:role/${{ vars.GH_OIDC_ROLE }}
          aws-region: ${{ vars.AWS_REGION || 'us-east-1' }}

      - name: Create/Update state machine
        env:
          SM_NAME: kerok-wistia-bronze-silver
          EMR_APP_ID: ${{ vars.EMR_APP_ID }}
          EMR_JOB_ROLE_ARN: ${{ vars.EMR_JOB_ROLE_ARN }}
          LAMBDA_VISITORS: ${{ vars.LAMBDA_VISITORS_NAME }}
          LAMBDA_MEDIA: ${{ vars.LAMBDA_MEDIA_NAME }}
          RAW_URI: ${{ vars.RAW_URI }}
          SILVER_URI: ${{ vars.SILVER_URI }}
          LOGS_URI: ${{ vars.LOGS_URI || 's3://kerok-wistia-logs/emr/' }}
        run: |
          # Read the ASL template and output ARN in a file:
          ASL_FILE="infra/stepfn/silver_state_machine.json"

          # Create or update the state machine
          ARN=$(aws stepfunctions list-state-machines --query "stateMachines[?name=='$SM_NAME'].stateMachineArn" --output text || true)
          if [ -z "$ARN" ] || [ "$ARN" == "None" ]; then
            ARN=$(aws stepfunctions create-state-machine \
              --name "$SM_NAME" \
              --role-arn "arn:aws:iam::${{ vars.AWS_ACCOUNT_ID }}:role/stepfn-service-role" \
              --definition file://$ASL_FILE \
              --type STANDARD \
              --query 'stateMachineArn' --output text)
          else
            aws stepfunctions update-state-machine \
              --state-machine-arn "$ARN" \
              --definition file://$ASL_FILE \
              --no-tracing
          fi
          echo "STATE_MACHINE_ARN=$ARN" >> $GITHUB_ENV

      - name: Create/Update daily EventBridge rule
        env:
          RULE_NAME: kerok-wistia-daily
          STATE_MACHINE_ARN: ${{ env.STATE_MACHINE_ARN }}
        run: |
          # 02:00 UTC daily (adjust as needed)
          SCHEDULE="cron(0 2 * * ? *)"

          aws events put-rule --name "$RULE_NAME" --schedule-expression "$SCHEDULE"

          # Allow Events to start executions
          aws events put-targets \
            --rule "$RULE_NAME" \
            --targets "Id"="1","Arn"="$STATE_MACHINE_ARN","RoleArn"="arn:aws:iam::${{ vars.AWS_ACCOUNT_ID }}:role/events-to-stepfn-role","Input"='{
              "lambda_visitors_name": "'"${{ vars.LAMBDA_VISITORS_NAME }}"'",
              "lambda_media_name": "'"${{ vars.LAMBDA_MEDIA_NAME }}"'",
              "raw_uri": "'"${{ vars.RAW_URI }}"'",
              "silver_uri": "'"${{ vars.SILVER_URI }}"'",
              "emr_app_id": "'"${{ vars.EMR_APP_ID }}"'",
              "emr_job_role_arn": "'"${{ vars.EMR_JOB_ROLE_ARN }}"'",
              "logs_uri": "'"${{ vars.LOGS_URI || 's3://kerok-wistia-logs/emr/' }}"'"
            }'
