name: Deploy Starter Lambda

on:
  push:
    paths:
      - ".github/workflows/deploy-starter-lambda.yml"
      - "src/infra/starter/**"
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:
  deploy-starter-lambda:
    environment: kerok-vistia-env
    if: ${{ toJSON(vars.ENABLE_DEPLOY) == '"true"' }}
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ vars.AWS_ACCOUNT_ID }}:role/${{ vars.GH_OIDC_ROLE }}
          aws-region: ${{ vars.AWS_REGION || 'us-east-1' }}

      - name: Package Lambda
        run: |
          echo "Packaging Starter Lambda..."
          mkdir -p build
          cd src/infra/starter
          zip -r ../../../build/starter_lambda.zip .
          cd -

      - name: Create/Update Lambda function
        env:
          LAMBDA_NAME: kerok-wistia-daily-pipeline-starter
          LAMBDA_ROLE_ARN: arn:aws:iam::${{ vars.AWS_ACCOUNT_ID }}:role/${{ vars.STARTER_LAMBDA_ROLE_NAME }}
        run: |
          ZIP_FILE="build/starter_lambda.zip"

          # Try to get existing config
          EXISTS=$(aws lambda get-function --function-name "$LAMBDA_NAME" --query 'Configuration.FunctionArn' --output text 2>/dev/null || true)

          if [ -z "$EXISTS" ] || [ "$EXISTS" == "None" ]; then
            echo "Creating Lambda $LAMBDA_NAME..."

            aws lambda create-function \
              --function-name "$LAMBDA_NAME" \
              --runtime python3.12 \
              --role "$LAMBDA_ROLE_ARN" \
              --handler "main.lambda_handler" \
              --zip-file "fileb://$ZIP_FILE" \
              --environment "Variables={STATE_MACHINE_NAME=kerok-wistia-bronze-silver,AWS_ACCOUNT_ID=${{ vars.AWS_ACCOUNT_ID }},AWS_REGION=${{ vars.AWS_REGION || 'us-east-1' }}}"

          else
            echo "Updating code for Lambda $LAMBDA_NAME..."

            aws lambda update-function-code \
              --function-name "$LAMBDA_NAME" \
              --zip-file "fileb://$ZIP_FILE"
          
            echo "Waiting for Lambda $LAMBDA_NAME to finish updating..."
            aws lambda wait function-updated \
              --function-name "$LAMBDA_NAME"

            echo "Updating environment variables for Lambda $LAMBDA_NAME..."
            aws lambda update-function-configuration \
              --function-name "$LAMBDA_NAME" \
              --environment "Variables={STATE_MACHINE_NAME=kerok-wistia-bronze-silver,AWS_ACCOUNT_ID=${{ vars.AWS_ACCOUNT_ID }},AWS_REGION=${{ vars.AWS_REGION || 'us-east-1' }}}"
          fi
