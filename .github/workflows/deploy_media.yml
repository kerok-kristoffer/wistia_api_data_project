name: Deploy Media Lambda

on:
  push:
    branches: [ master ]
    paths:
      - 'src/**'
      - 'ingestion/**'
      - '.github/workflows/deploy_media.yml'
  pull_request:
    branches: [ master ]
    paths:
      - 'src/**'
      - 'ingestion/**'
      - '.github/workflows/deploy_media.yml'

permissions:
  id-token: write
  contents: read

concurrency:
  group: deploy-media-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Regular deploy to prod for pushes to main/master
  deploy:
    environment: kerok-vistia-env
    if: ${{ toJSON(vars.ENABLE_DEPLOY) == '"true"' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Configure AWS (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ vars.AWS_ACCOUNT_ID }}:role/${{ vars.GH_OIDC_ROLE }}
          aws-region: ${{ vars.AWS_REGION || 'us-east-1' }}

      - name: Build deployment zip
        run: |
          set -e
          rm -rf build lambda_media.zip
          python -m pip install -U pip
          pip install -r lambda_requirements.txt -t build
          mkdir -p build_tmp
          cp -r src/* build_tmp/
          cp -r build/* build_tmp/
          (cd build_tmp && zip -r ../lambda_media.zip .)
          ls -lh lambda_media.zip

      - name: Who am I?
        run: aws sts get-caller-identity

      - name: Update code
        env:
          LAMBDA_NAME: ${{ vars.LAMBDA_MEDIA_NAME }}
        run: |
          aws lambda update-function-code \
            --function-name "$LAMBDA_NAME" \
            --zip-file fileb://lambda_media.zip \
            --publish

      - name: Smoke invoke (media)
        env:
          LAMBDA_NAME: ${{ vars.LAMBDA_MEDIA_NAME }}
        run: |
          set -euo pipefail

          ENVELOPE=$(aws lambda invoke \
            --function-name "$LAMBDA_NAME" \
            --payload '{"smoke_test": true}' \
            --cli-binary-format raw-in-base64-out \
            --log-type Tail \
            --no-cli-pager \
            out.json \
            --query '{StatusCode:StatusCode,FunctionError:FunctionError,LogResult:LogResult}' \
            --output json)

          echo "Invoke envelope:"
          echo "$ENVELOPE" | jq .

          ERR=$(echo "$ENVELOPE" | jq -r '.FunctionError // ""')
          SC=$(echo "$ENVELOPE" | jq -r '.StatusCode // empty')
          LOGS=$(echo "$ENVELOPE" | jq -r '.LogResult // ""' | base64 -d || true)

          # Print logs if present
          if [ -n "$LOGS" ]; then
            echo "---- Lambda logs ----"
            echo "$LOGS"
            echo "---------------------"
          fi

          # Fail on non-200 or any FunctionError
          if [ "$SC" != "200" ]; then
            echo "Smoke test failed: non-200 StatusCode ($SC)"
            exit 1
          fi
          if [ -n "$ERR" ] && [ "$ERR" != "null" ]; then
            echo "Smoke test failed: FunctionError=$ERR"
            echo "---- Lambda response body ----"
            cat out.json | jq . || cat out.json
            exit 1
          fi

          # Optional: basic payload sanity check
          jq -e 'type=="object" or type=="array"' out.json >/dev/null || {
            echo "Unexpected payload type from Lambda"
            cat out.json
            exit 1
          }

          echo "Smoke test passed."
