name: Deploy Media Lambda

on:
  push:
    branches: [ master ]
    paths:
      - 'src/**'
      - 'ingestion/**'
      - '.github/workflows/deploy_media.yml'
  pull_request:
    branches: [ master ]
    paths:
      - 'src/**'
      - 'ingestion/**'
      - '.github/workflows/deploy_media.yml'

permissions:
  id-token: write
  contents: read

concurrency:
  group: deploy-media-${{ github.ref }}
  cancel-in-progress: true

env:
  AWS_REGION: us-east-1
  MEDIA_LAMBDA_NAME: kerok-wistia-media-ingest-stg  # <-- staging function for PRs

jobs:
  # Regular deploy to prod for pushes to main/master
  deploy:
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::644171584843:role/gh-oidc-wistia-deployer
          aws-region: ${{ env.AWS_REGION }}

      # …build package, zip, update-function-code…

      - name: Smoke test (prod)
        run: |
          aws lambda invoke \
            --function-name kerok-wistia-media-ingest \
            --payload '{"media_ids":["gskhw4w4lm"]}' \
            --cli-binary-format raw-in-base64-out \
            --log-type Tail \
            >(jq -r .) \
            --query 'StatusCode' \
          | grep -q '^200$'

  # PR smoke test job (no deploy)
  pr-smoke:
    if: github.event_name == 'pull_request' && github.event.pull_request.head.repo.fork == false
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::644171584843:role/gh-oidc-wistia-deployer
          aws-region: ${{ env.AWS_REGION }}

      - name: Invoke staging media lambda (smoke)
        run: |
          set -euo pipefail
          # Fail the job if Lambda reports FunctionError or non-200
          OUT=$(aws lambda invoke \
            --function-name "${{ env.MEDIA_LAMBDA_NAME }}" \
            --payload '{"media_ids":["gskhw4w4lm"]}' \
            --cli-binary-format raw-in-base64-out \
            --log-type Tail \
            /dev/stdout)
          echo "$OUT" | jq -r '.LogResult' | base64 -d || true
          STATUS=$(echo "$OUT" | jq -r '.StatusCode')
          FUNCERR=$(echo "$OUT" | jq -r '.FunctionError // empty')
          test "$STATUS" = "200" && test -z "$FUNCERR"